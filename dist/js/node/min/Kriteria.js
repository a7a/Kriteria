!function(t,e){"use strict";var n=require("./lib/getProperty.js").getProperty,i=require("./lib/matchPrefix.js").matchPrefix,r=require("./lib/Condition.js").Condition,o=require("./lib/evaluation.js").evaluation,s=require("./lib/keys_reference.js").keysReference,l=function(){this._conditionAnd=[],this._conditionOr=[],this._not_flg=!1};l._name_="Kriteria",l.prototype.getConditionAnd=function(){return this._conditionAnd},l.prototype.getConditionOr=function(){return this._conditionOr},l._JS_OPERATOR={eq:"===",ne:"!==",lt:"<",le:"<=",gt:">",ge:">="},l.prototype.addAnd=function(t){this._conditionAnd[this._conditionAnd.length]=t},l.prototype.addOr=function(t){this._conditionOr[this._conditionOr.length]=t},l.prototype.and=function(t){var e=typeof t,n=null;if("string"===e||t instanceof String||"number"===e||t instanceof Number)return o("and",t,this);if(t instanceof l)return n=t,this.addAnd(new r("","",[],"",n)),this;if("function"==typeof t)return n=new l,t(n),this.addAnd(new r("","",[],"",n)),this;throw new Error("invalid type of argument. ("+e+")")},l.prototype.or=function(t){var e=typeof t,n=null;if("string"===e||t instanceof String||"number"===e||t instanceof Number)return o("or",t,this);if(t instanceof l)return n=t,this.addOr(new r("","",[],"",n)),this;if("function"==typeof t)return n=new l,t(n),this.addOr(new r("","",[],"",n)),this;throw new Error("invalid type of argument. ("+e+")")},l.prototype.not=function(){return this._not_flg=!this._not_flg,this},l.parse=function(t){var e=new l,n="";for(n in t.and)e.addAnd(t.and[n]);for(n in t.or)e.andOr(t.or[n]);return t.not&&e.not(),e},l.prototype.match=function(t){var e=0,i=0,r=0,o=0,s="",a="",f=[],h="",c=null,d=[],_=!1,u=null,g=null;for(e=0,i=this._conditionAnd.length;e<i;e+=1)if(u=this._conditionAnd[e],u.criteria instanceof l){if(_=u.criteria.match(t),!_)break}else{if(s=u.left_key,a=u.operator,f=u.right_key,h=u.key_type,c=n(t,s),"value"===h)d=f;else if("key"===h)if(g=n(t,f[0]),Array.isArray(g))if("match"===a||"not_match"===a)for(d=[],r=0,o=g.length;r<o;r+=1)null===g[r]||void 0===g[r]||""===g[r]?d[r]=g[r]:d[r]=new RegExp(g[r]);else d=g;else d="match"===a||"not_match"===a?null===g||void 0===g||""===g?g:[new RegExp(g)]:[g];if(_=void 0!==d&&!~d.indexOf(void 0)&&void 0!==c&&this._compare(c,a,d),!_)break}if(_)return!!(!0^this._not_flg);for(e=0,i=this._conditionOr.length;e<i;e+=1)if(u=this._conditionOr[e],u.criteria instanceof l){if(_=u.criteria.match(t))return!!(!0^this._not_flg)}else{if(s=u.left_key,a=u.operator,f=u.right_key,h=u.key_type,c=n(t,s),"value"===h)d=f;else if("key"===h)if(g=n(t,f[0]),Array.isArray(g))if("match"===a||"not_match"===a)for(d=[],r=0,o=g.length;r<o;r+=1)null===g[r]||void 0===g[r]||""===g[r]?d[r]=g[r]:d[r]=new RegExp(g[r]);else d=g;else d="match"===a||"not_match"===a?null===g||void 0===g||""!==g?g:[new RegExp(g)]:[g];if(_=void 0!==d&&!~d.indexOf(void 0)&&void 0!==c&&this._compare(c,a,d))return!!(!0^this._not_flg)}return!!(!1^this._not_flg)},l.prototype._compare=function(t,e,n){var i=!1;switch(e){case"eq":i=n[0]===t;break;case"ne":i=n[0]!==t;break;case"lt":i=n[0]>t;break;case"le":i=n[0]>=t;break;case"gt":i=n[0]<t;break;case"ge":i=n[0]<=t;break;case"in":i=!!~n.indexOf(t);break;case"not_in":i=!~n.indexOf(t);break;case"between":i=n[0]<=t&&n[1]>=t;break;case"not_between":i=n[0]>t||n[1]<t;break;case"match":i=null===n[0]?null===t||void 0===t:null!==t&&(""===n[0]?""===t:n[0].test(t));break;case"not_match":i=null===n[0]?null!==t&&void 0!==t:null===t||(""===n[0]?""!==t:!n[0].test(t))}return i},l.prototype.matcher=function(){return new Function("$","return "+this._createMatchingExpression())},l.prototype._createMatchingExpression=function(){var t=0,e=0,n=[],i=[],r="",o="",s=null,a="";for(t=0,e=this._conditionAnd.length;t<e;t+=1)s=this._conditionAnd[t],s.criteria instanceof l?n[n.length]="("+s.criteria._createMatchingExpression()+")":n[n.length]=this._createExpression(s);for(t=0,e=this._conditionOr.length;t<e;t+=1)s=this._conditionOr[t],s.criteria instanceof l?i[i.length]="("+s.criteria._createMatchingExpression()+")":i[i.length]=this._createExpression(s);return r=n.join(" && "),o=i.join(" || "),r&&o?a=r+" || "+o+" ":o?r||(a=o):a=r,this._not_flg&&(a="!("+a+")"),a},l.prototype._createExpression=function(t){return"("+this._createJsExpressionOfKeyIsNotUndefined(t.left_key)+" && "+("key"===t.key_type?this._createJsExpressionOfKeyIsNotUndefined(t.right_key[0])+" && ":"")+this._createJsExpression(t)+")"},l.prototype._createJsExpression=function(t){var e=s("$",t.left_key.split(".")),n=t.operator,i=t.right_key,r=t.key_type,o=l._JS_OPERATOR[n],a=s("$",i[0]).toString();return o?e+" "+o+" "+this._toStringExpressionFromValue(i[0],r):"in"===n?"value"===r?"!!~"+this._toStringExpressionFromArray(i)+".indexOf("+e+")":"(Array.isArray("+a+") ? !!~"+a+".indexOf("+e+"): "+a+" === "+e+")":"not_in"===n?"value"===r?"!~"+this._toStringExpressionFromArray(i)+".indexOf("+e+")":"(Array.isArray("+a+") ? !~"+a+".indexOf("+e+"): "+a+" !== "+e+")":"between"===n?e+" >= "+this._toStringExpressionFromValue(i[0],r)+" && "+e+" <= "+this._toStringExpressionFromValue(i[1],r):"not_between"===n?e+" < "+this._toStringExpressionFromValue(i[0],r)+" || "+e+" > "+this._toStringExpressionFromValue(i[1],r):"match"===n?void 0!==i[0]&&(null===i[0]?"("+e+" === null ? true : false)":""===i[0]?"("+e+" === '' ? true : false)":"("+i[0]+".test("+e+"))"):"not_match"===n?void 0!==i[0]&&(null===i[0]?"("+e+" === null ? false : true)":""===i[0]?"("+e+" === '' ? false : true)":"(!"+i[0]+".test("+e+"))"):null},l.prototype._createJsExpressionOfKeyIsNotUndefined=function(t){for(var e=t.split("."),n=[],i=[],r=0,o=e.length;r<o;r+=1)n[n.length]=e[r],i[i.length]=s("$",n).toString()+" !== void 0";return i.join(" && ")},l.prototype._createJSExpressionOfKeyIsUndefined=function(t){for(var e=t.split("."),n=[],i=[],r=0,o=e.length;r<o;r+=1){n[n.length]=e[r];var l=s("$",n);i[i.length]=l+" === void 0",i[i.length]=l+" === null"}return i.join(" || ")},l.prototype._toStringExpressionFromArray=function(t){for(var e=[],n=0,i=t.length;n<i;n+=1)e[e.length]=this._toStringExpressionFromValue(t[n],"value");return"["+e.join(", ")+"]"},l.prototype._toStringExpressionFromValue=function(t,e){return"value"===e&&("string"==typeof t||t instanceof String)?'"'+t+'"':"key"===e?s("$",t.split(".")).toString():t+""},l.prototype.splitByKeyPrefixes=function(t){if(!Array.isArray(t)||0===t.length)return null;var e={},n=null,r=null,o=[],s="",a="",f="",h=!0,c=!0,d=!0,_="",u=0,g=0,p=0,y=0;for(u=0,g=t.length;u<g;u+=1)e[t[u]]=new l;for(e["else"]=new l,u=0,g=this._conditionAnd.length;u<g;u+=1)if(n=this._conditionAnd[u],n.criteria instanceof l){r=n.criteria.splitByKeyPrefixes(t);for(_ in r)null!==r[_]&&e[_].and(r[_])}else{for(o=[],s=n.left_key,a=n.right_key[0],f=n.key_type,d=!1,p=0,y=t.length;p<y;p+=1)if(o[o.length]=t[p],h=i(s,o),"key"===f&&(c=i(a,o)),"value"===f&&h||"key"===f&&h&&c){e[t[p]].addAnd(n),d=!0;break}d||e["else"].addAnd(n)}for(u=0,g=this._conditionOr.length;u<g;u+=1)if(n=this._conditionOr[u],n.criteria instanceof l){r=n.criteria.splitByKeyPrefixes(t);for(_ in r)null!==r[_]&&e[_].or(r[_])}else{for(o=[],s=n.left_key,a=n.right_key[0],f=n.key_type,d=!1,p=0,y=t.length;p<y;p+=1)if(o[o.length]=t[p],h=i(s,o),"key"===f&&(c=i(a,o)),"value"===f&&h||"key"===f&&h&&c){e[t[p]].addOr(n),d=!0;break}d||e["else"].addOr(n)}for(_ in e)e[_].getConditionAnd().length>0||e[_].getConditionOr().length>0?e[_]._not_flg=this._not_flg:e[_]=null;return e},l.prototype.merge=function(t,e){var n=new l,i=t.getConditionAnd(),r=t.getConditionOr(),o=null,s=!1,a=0,f=0,h=0,c=0;if(this._not_flg!==t._not_flg)throw new Error("Kriteria#merge - collision to not flag.");for(a=0,f=this._conditionAnd.length;a<f;a+=1)n.addAnd(this._conditionAnd[a]);for(a=0,f=this._conditionOr.length;a<f;a+=1)n.addOr(this._conditionOr[a]);if(e){for(a=0,f=i.length;a<f;a+=1){for(o=i[a],s=!1,h=0,c=this._conditionAnd.length;h<c;h+=1)if(0===o.compareTo(this._conditionAnd[h])){s=!0;break}s||n.addAnd(o)}for(a=0,f=r.length;a<f;a+=1){for(o=r[a],s=!1,h=0,c=this._conditionOr.length;h<c;h+=1)if(0===o.compareTo(this._conditionOr[h])){s=!0;break}s||n.addOr(o)}}else{for(a=0,f=i.length;a<f;a+=1)n.addAnd(i[a]);for(a=0,f=r.length;a<f;a+=1)n.addOr(r[a])}return n},l.prototype.compareTo=function(t){var e=function(t,e){return t.compareTo(e)},n=t.getConditionAnd(),i=t.getConditionOr(),r=null,o=null,s=!0,l=0,a=0,f=0,h=0;if(this._conditionAnd.sort(e),n.sort(e),this._conditionOr.sort(e),i.sort(e),this._not_flg&&!t._not_flg)return-1;if(!this._not_flg&&t._not_flg)return 1;for(l=this._conditionAnd.length,a=n.length,h=l>a?l:a,f=0;f<h;f+=1){if(r=this._conditionAnd[f],o=n[f],!r)return-1;if(!o)return 1;if(s=r.compareTo(o),0!==s)return s}for(l=this._conditionOr.length,a=i.length,h=l>a?l:a,f=0;f<h;f+=1){if(r=this._conditionOr[f],o=i[f],!r)return-1;if(!o)return 1;if(s=r.compareTo(o),0!==s)return s}return 0},l.prototype.removePrefixes=function(t){var e=null,n=null,i=0,r=0;if(null===t||void 0===t||!Array.isArray(t)||0===t.length)return this;for(e=new RegExp("^("+t.join("|")+")."),i=0,r=this._conditionAnd.length;i<r;i+=1)n=this._conditionAnd[i],n.criteria instanceof l?n.criteria.removePrefixes(t):(n.left_key=n.left_key.replace(e,""),"key"===n.key_type&&(n.right_key[0]=n.right_key[0].replace(e,"")));for(i=0,r=this._conditionOr.length;i<r;i+=1)n=this._conditionOr[i],n.criteria instanceof l?n.criteria.removePrefixes(t):(n.left_key=n.left_key.replace(e,""),"key"===n.key_type&&(n.right_key[0]=n.right_key[0].replace(e,"")));return this},t.Kriteria=l,e.Kriteria=l}(this,(0,eval)("this").window||this);